name: Supabase Keepalive

# Jalankan setiap 5 hari untuk menjaga project Supabase tetap aktif
# Supabase free tier akan pause project setelah 7 hari tidak ada aktivitas
on:
  schedule:
    # Setiap 5 hari pada jam 00:00 UTC (07:00 WIB)
    - cron: '0 0 */5 * *'

  # Izinkan manual trigger untuk testing
  workflow_dispatch:

jobs:
  keepalive:
    runs-on: ubuntu-latest

    steps:
      - name: Run keepalive heartbeat via Supabase REST API
        env:
          SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
        run: |
          echo "üîÑ Running Supabase keepalive at $(date)"
          echo "üìç Supabase URL: $SUPABASE_URL"

          # Coba query ke table monthly_reports via REST API
          HTTP_STATUS=$(curl -s -o /tmp/response.txt -w "%{http_code}" \
            -X GET "$SUPABASE_URL/rest/v1/monthly_reports?select=count&limit=1" \
            -H "apikey: $SUPABASE_KEY" \
            -H "Authorization: Bearer $SUPABASE_KEY" \
            -H "Content-Type: application/json")

          echo "HTTP Status: $HTTP_STATUS"
          echo "Response: $(cat /tmp/response.txt)"

          if [ "$HTTP_STATUS" -eq 200 ] || [ "$HTTP_STATUS" -eq 206 ]; then
            echo "‚úÖ Supabase keepalive berhasil! Database tetap aktif."
            exit 0
          else
            echo "‚ö†Ô∏è monthly_reports gagal, mencoba table lain..."

            # Coba table lain sebagai fallback
            HTTP_STATUS2=$(curl -s -o /tmp/response2.txt -w "%{http_code}" \
              -X GET "$SUPABASE_URL/rest/v1/sections?select=count&limit=1" \
              -H "apikey: $SUPABASE_KEY" \
              -H "Authorization: Bearer $SUPABASE_KEY" \
              -H "Content-Type: application/json")

            echo "HTTP Status 2: $HTTP_STATUS2"
            echo "Response 2: $(cat /tmp/response2.txt)"

            if [ "$HTTP_STATUS2" -eq 200 ] || [ "$HTTP_STATUS2" -eq 206 ]; then
              echo "‚úÖ Supabase keepalive berhasil via fallback table!"
              exit 0
            else
              echo "‚ùå Semua keepalive attempts gagal."
              echo "Status codes: $HTTP_STATUS, $HTTP_STATUS2"
              exit 1
            fi
          fi

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ö†Ô∏è Supabase keepalive GAGAL!"
          echo "Kemungkinan penyebab:"
          echo "1. Secrets belum di-set dengan benar"
          echo "2. Supabase project sudah di-pause"
          echo "3. Nama table tidak ada"
          echo ""
          echo "Silakan cek dashboard Supabase Anda."
