name: Supabase Keepalive

# ============================================================
# Otomatis: Berjalan setiap 4 hari (Supabase pause setelah 7 hari)
# Tidak perlu trigger manual - semua otomatis!
# ============================================================
on:
  schedule:
    # Setiap 4 hari pada jam 08:00 WIB (01:00 UTC)
    # Lebih aman daripada 5 hari karena ada buffer 3 hari
    - cron: '0 1 */4 * *'

jobs:
  keepalive:
    name: Ping Supabase Database
    runs-on: ubuntu-latest

    steps:
      - name: Ping Supabase REST API
        env:
          SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
        run: |
          echo "================================================"
          echo "  Supabase Keepalive - $(date '+%Y-%m-%d %H:%M')"
          echo "================================================"

          # Validasi secrets tidak kosong
          if [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_KEY" ]; then
            echo "‚ùå ERROR: Secrets VITE_SUPABASE_URL atau VITE_SUPABASE_ANON_KEY belum diset!"
            echo "   Buka: Settings > Secrets and variables > Actions"
            exit 1
          fi

          echo "üìç URL: $SUPABASE_URL"
          echo ""

          # Coba 3 table berbeda sebagai fallback
          TABLES="monthly_reports sections members"
          SUCCESS=0

          for TABLE in $TABLES; do
            echo -n "   Mencoba table '$TABLE'... "

            STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
              --max-time 15 \
              -X GET "$SUPABASE_URL/rest/v1/$TABLE?select=count&limit=1" \
              -H "apikey: $SUPABASE_KEY" \
              -H "Authorization: Bearer $SUPABASE_KEY")

            if [ "$STATUS" = "200" ] || [ "$STATUS" = "206" ]; then
              echo "‚úÖ Berhasil! (HTTP $STATUS)"
              SUCCESS=1
              break
            else
              echo "‚è≠ Skip (HTTP $STATUS)"
            fi
          done

          echo ""
          if [ "$SUCCESS" = "1" ]; then
            echo "‚úÖ KEEPALIVE SUKSES! Database Supabase tetap aktif."
            echo "   Project tidak akan di-pause."
            exit 0
          else
            echo "‚ùå KEEPALIVE GAGAL! Semua table tidak ada atau tidak bisa diakses."
            echo ""
            echo "Kemungkinan penyebab:"
            echo "  1. Secrets salah - cek VITE_SUPABASE_URL dan VITE_SUPABASE_ANON_KEY"
            echo "  2. Nama table berbeda - update daftar TABLES di workflow"
            echo "  3. Supabase project sudah di-pause - buka dashboard untuk restore"
            exit 1
          fi
